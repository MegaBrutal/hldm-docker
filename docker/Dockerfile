FROM debian:bookworm-slim

ENV VERSION 2023.11
ENV RELEASE_DATE 2023-11-18
ENV LANG C.UTF-8
ENV LC_ALL C.UTF-8
ENV DEBIAN_FRONTEND noninteractive

ARG game=valve
ARG hlds=hldm.tar.xz

# Update base image and install dependencies.
RUN dpkg --add-architecture i386 \
    && sed -i "s/^Components: main$/Components: main non-free/g" /etc/apt/sources.list.d/debian.sources \
    && apt-get update && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        file \
        gzip \
        bzip2 \
        xz-utils \
        zstd \
        p7zip-rar \
        libc6:i386 \
    && apt-get clean && rm -rf /var/lib/apt/lists/* \
    && groupadd -r steam && useradd -r -g steam -m -d /opt/steam steam \
    && mkdir /deploy

ADD ${hlds} /opt/steam/
RUN chown -vR steam:steam /opt/steam/hldm

USER steam
WORKDIR /opt/steam
COPY ./hldm.install /opt/steam

# Download SteamCMD and install HLDM. Abort container build on failure.
RUN curl -sL media.steampowered.com/client/installer/steamcmd_linux.tar.gz | tar xzvf - \
    && ldd /opt/steam/linux32/steamcmd \
    && ./steamcmd.sh +login anonymous +quit \
    && rm -fr /opt/steam/hldm/cstrike \
    && rm -fr /opt/steam/hldm/siteserverui \
    && rm -fr /opt/steam/hldm/linux64 \
    && stat ./hldm/valve/gfx.wad

# Fix error that steamclient.so is missing.
RUN mkdir -p $HOME/.steam \
    && ln -s /opt/steam/linux32 $HOME/.steam/sdk32 \
    && echo 70 > /opt/steam/hldm/steam_appid.txt

WORKDIR /opt/steam/hldm

# Copy configs, Metamod, Stripper2 and AMX.
COPY --chown=steam:steam deploy/copy-gamedir ${game}
COPY --chown=steam:steam ./hlds_deploy ./hlds_deploy
RUN sed -i "s/^TARGET_GAMEDIR=.*$/TARGET_GAMEDIR=${game}/" hlds_deploy

EXPOSE 27015
EXPOSE 27015/udp

# Start server.
ENTRYPOINT ["./hlds_deploy", "-timeout 15"]

# Default start parameters.
CMD ["+maxplayers 12", "+map crossfire"]

# Labels
LABEL vendor=steamcalculator.com \
    hldm.docker.version="$VERSION" \
    hldm.docker.release-date="$RELEASE_DATE"
